# CHANGELOG

## 2026-02-25

- `/account` の「未ログイン回答の紐づけ」セクションを廃止し、回答紐づけ導線をイベントページ内の「回答紐づきを編集」に統一。
- `/account` の使い方ツアーから未ログイン回答紐づけステップを削除し、全体を 7 ステップへ更新。
- 未ログインで回答を進める際に確認ダイアログを追加し、`ログインして回答 / ログインせず回答 / 戻る` を提示してログイン導線を強化。
- 未ログイン回答の導線ボタン配置を調整し、`ログインして進む` を右側（主操作の位置）に統一。
- 予定一括管理の保存で `23:00-00:00` など日付またぎ枠を編集した際、終了時刻を開始日の `00:00` と誤解釈して更新失敗する不具合を修正し、イベント作成時と同様に翌日 `00:00` 終了として保存するように統一。
- 予定一括管理・反映プレビューの日付またぎ枠は、`00:00` 終了を `24:00` 表示へ統一。表示上は「その日の終わり」までの枠として扱い、保存時のみ翌日 `00:00` へ正規化するよう修正。
- 予定一括管理の最終時刻ラベル（`24:00`）が表下端で視認しづらい問題を修正し、下端行に常時表示されるように改善。
- サーバー側 `upsertUserScheduleBlock` でも、同日 `23:00-00:00` 指定を翌日 `00:00` 終了へ補正するガードを追加し、クライアント差異があっても保存できるように改善。
- 回答ウィザードの曜日一括入力で、セルをすべて `×` に戻した曜日を未選択扱いへ戻すよう修正し、意図しない大量の不可テンプレ保存を防止。
- 回答ウィザードの「週予定保存」で `22:00-24:00`（内部キー `22:00-00:00`）の枠が保存対象から除外される不具合を修正し、保存時に `24:00` へ正規化して保持できるよう改善。
- 同期範囲モーダルに `確認へ戻る` を追加し、送信前に確認ステップへ戻って見直せるよう改善。
- アカウントページツアーの進捗表示を、実際に表示可能なステップ数ベースで計算するよう修正し、optional ステップ省略時の `1/8 -> 3/8` ずれを解消。
- ツアーのステップ数表記を実装に合わせて `8ステップ` へ修正（README / architecture / CHANGELOG）。
- 認証付きE2Eの実行導線（`test:e2e:chrome` / `test:e2e:auth`）を README に追記し、公開フローとの使い分けを明確化。
- 未ログイン回答のアカウント紐づけで、対象回答がすでに別アカウントに紐づいている場合は拒否するガードを追加。
- `user_event_availability_overrides` の保存を置換扱いに修正し、空送信時や差分更新時に不要な古い override が残らないよう改善。
- イベントページの「回答紐づきを編集」は参加予定入力セクション右上のボタンのみ表示し、操作はポップアップで行うUIへ改善。アカウントページ側の一括確認・履歴からの解除導線は継続利用できるよう維持。
- 回答ウィザードの「曜日一括入力」表は、時間ラベルをマス境界基準で表示し、最下段に終了時刻を表示するレイアウトへ調整。
- 回答ウィザードの「予定確認・修正」表は、セルの見た目差（可/不可/保護）を統一しつつ、最下段に終了時刻を表示するレイアウトへ調整。
- 回答ウィザードの曜日一括入力／予定確認表で、スマホ幅時にセル内の四角表示が罫線からずれて見える不具合を修正。モバイルはセル内容を `w-full` 基準で描画し、列幅の端数によるはみ出しを防止。
- 回答ウィザードのスマホ表示デザインを再調整し、曜日一括入力／予定確認表のセルを「角丸の正方形」基準へ統一。セル余白・カード内余白を圧縮して、狭い画面でも視認しやすいレイアウトへ改善。
- 回答ウィザードのスマホ表示で、セル内四角の周囲余白をさらに圧縮。四角サイズを維持したままマス内の余白感を減らし、視認性を改善。
- 回答ウィザードのスマホ表示で、ボタン（セル四角）を大きく見せるために表周辺余白を再調整。カード内余白・先頭列幅・表外周マージンを縮小し、セル描画領域を拡張。

## 2026-02-19

- `/account` に新規ユーザー向けの「使い方ツアー」を追加し、初回ログイン時のみ 8 ステップのページガイドを自動表示するように改善。
- 回答UIをウィザード化し、新規回答を4ステップ（回答者情報→曜日一括→ヒートマップ→確認送信）、編集回答を3ステップへ再設計。
- 未ログイン導線の文言を `ログインして進む` / `ログインせずに進む` へ統一し、ログイン目的を本人判別・回答紐づけ用途として明示。
- 回答入力は `曜日一括表` と `ヒートマップ表` の2種へ集約し、旧 `list/table` モードを廃止。
- `ScheduleContext` に未充足・カバー状況の集計値（`coveredDateIds` / `uncoveredDateKeys` / `uncoveredDayCount` / `requireWeeklyStep` / `hasAccountSeedData`）を追加。
- 新規回答の初期反映はモーダル確認方式を廃止し、ログイン時はアカウント予定を初期値へ自動反映する仕様へ変更。
- ツアー終了状態（完了/スキップ）は `localStorage(account_page_tour_state_v1)` に保存し、通常利用時の自動再表示を抑止する仕様を追加。
- `/account` 見出し付近に「使い方ツアー」再開ボタンを追加し、任意タイミングで手動再表示できる導線を追加。
- ツアー対象識別のため `data-tour-id` をアカウント主要セクションへ追加し、対象セクションが存在しない場合はステップを自動スキップする挙動を実装。
- アカウントツアー仕様の設計メモ（`docs/architecture/account-onboarding-tour.md`）を追加。
- アカウントページの「マイ予定設定」で初期表示タブを「予定一括管理」に変更。
- 予定一括管理の週ナビゲーションは、データ範囲に関わらず「今日を含む週」を初期表示するように変更。
- 週送りUIのページ番号（`A / A`）表示を予定一括管理系では非表示にし、日付期間ラベル中心で確認できるよう改善。
- 週ごとの用事・予定一括管理ともに、編集時は表の下部にも `更新する` ボタンを表示し、更新漏れを防止。
- 週ごとの用事は週テンプレ管理であることを明確にするため、`表示期間` バーを削除。
- アカウントページで `マイ予定設定` 見出しが重複表示される問題を修正し、タイトル表示を1箇所に統一。
- 新規回答時の「過去の予定から反映」で、予定一括管理（`user_schedule_blocks`）より週テンプレが優先されてしまうケースを修正。予定一括管理の保存値を壁時計時刻基準へ正規化し、反映判定と同一基準で扱うように統一。
- 予定一括管理の自動反映で、連続した複数の可ブロック（例: `09:00-10:00` と `10:00-11:00`）が対象枠を覆う場合でも可判定されるように判定ロジックを改善。
- 回答送信時の同期範囲モーダルから `キャンセル` ボタンを削除し、`全イベントへ反映` を `アカウント予定に保存して反映` へ文言変更。
- 未ログイン回答の紐づけはページ表示時に候補を自動確認し、候補がない場合はセクション自体を非表示化。候補がある場合はアカウント画面上部に表示して優先的に対処できる配置へ変更。
- 回答イベントへの反映プレビューは、イベントごとに「変更が発生した最初の週」を初期表示するよう改善し、差分発生箇所を即座に把握できるように変更。
- 回答イベントへの反映プレビューの件数バッジは、`0件` の項目を非表示にし、`変更/可→不可/不可→可/保護` を意味別の色で判別しやすく改善。
- 予定一括管理の更新成功メッセージ（`予定一括管理を更新しました`）は、表示後に自動で消えるように改善し、画面上に残り続けないよう修正。
- マイ予定設定タブの並び順を調整し、初期表示である `予定一括管理` を左側（先頭）に配置。
- 認証付きE2Eで入力画面の「過去の予定から反映」モーダルが遅延表示される場合でも、テスト開始時に確実に閉じる待機処理へ修正し、既存回答紐づけシナリオの不安定化を解消。
- 認証付きE2Eの予定一括管理シード投入は、`user_schedule_blocks(user_id,start_time,end_time)` の一意制約重複時に更新へ切り替える `upsert` 相当SQLへ変更し、再実行時の重複エラーを解消。
- 回答画面のヒートマップ表UIをモバイル向けに調整し、`/account` の予定一括管理と同系統のセル密度・ヘッダー構成・余白へ統一して視認性と操作性を改善（ドラッグによる範囲選択UXは維持）。
- 回答画面の「曜日ごとの時間帯設定」表UIもモバイル向けに調整し、`/account` の予定一括管理UIに合わせてヘッダー・時刻ラベル・セルサイズを統一（ドラッグによる一括変更UXは維持）。
- 曜日ごとの時間帯設定では、横方向ドラッグでの連続選択を優先するため横スクロールを無効化し、スマホでもなぞり操作を阻害しないように調整。
- 曜日ごとの時間帯設定のセル配置を再調整し、モバイルでは列幅（`w-11`）を固定したうえでセル内部を `flex` 中央寄せに統一して、選択セルが右に寄って見える表示崩れを修正。
- 曜日ごとの時間帯設定で土曜・日曜列が欠けるケースを防ぐため、モバイル列幅の固定指定と負マージンを廃止し、表幅をコンテナ内で均等配分するレイアウトへ調整。
- 曜日ごとの時間帯設定はスマホ操作性を優先し、はみ出しの原因となる `w-screen` 展開を廃止。カード余白をモバイルで縮小しつつセル高さ・記号サイズ・時刻/曜日ラベルを拡大して、画面内に収めたまま操作しやすく改善。
- 曜日ごとの時間帯設定テーブル内では `touchmove` を抑止し、`overflow-hidden` と `overscrollBehavior: none` を適用して縦方向スクロールも発生しないように調整。

## 2026-02-10

- 回答画面の曜日ごとの時間帯設定で `設定を適用する` を押した際に、`今回のみ適用 / ユーザ設定への反映（保存・更新を自動判定） / キャンセル` を選べる確認ダイアログを追加。
- 予定一括管理（`user_schedule_blocks`）の時刻形式が `タイムゾーンあり/なし` で混在した場合に新規回答の自動反映が欠落する不具合を修正し、重なり判定を同一のローカル時刻比較ロジックへ統一。
- 認証付きE2Eに「2イベント実データで、予定一括管理→新規回答自動反映→回答イベント反映プレビュー→適用」まで検証するケースを追加し、再発防止を強化。
- ユーザ設定への反映を選んだ場合は、曜日×時間帯設定を週ごとの用事（`user_schedule_templates` の `manual`）へ反映し、ボタン文言を `保存して適用 / 更新して適用 / 保存・更新して適用 / 維持して適用` で自動切り替えするよう改善。
- 未ログイン時の曜日ごとの時間帯設定モーダルでは、ユーザ設定保存導線を非表示にして `今回のみ適用` のみ選べるように変更（保存不可状態をUIで明確化）。
- 未ログイン時は曜日設定の確認モーダル自体を表示せず、`設定を適用する` で即時に「今回のみ適用」を実行するように変更。
- マイ予定設定の「週ごとの用事」は時間行の算出を週テンプレ由来のみに修正し、予定一括管理（日付ブロック）の時間枠が混在しないように改善。
- 週テンプレ未作成時でも `08:00-20:00` のデフォルト行で編集を開始できるようにし、初期状態から週ごとの用事を登録しやすく改善。
- 回答画面の曜日ごとの時間帯設定をユーザ設定へ保存する際、既存の週テンプレ時間枠を優先して整合させるように改善（イベント固有の時間枠でテンプレ軸が崩れる問題を緩和）。
- ログイン中に回答画面の曜日ごとの時間帯設定を開いた際、アカウントの週ごとの用事（手動テンプレ）を自動で読み込み、曜日マトリクスへ初期反映するよう改善。
- アカウントページの履歴表示名称を「回答履歴」に変更し、履歴項目に「回答済み」バッジと「自分の回答名」を表示するよう改善。
- 回答履歴から「自分の回答名」表示を削除し、イベントページ側で自分の回答を識別できる表示（参加者トグル・詳細表示・既存回答編集リスト）を追加。

## 2026-02-06

- アカウントページの「マイ予定テンプレ」を曜日×時間帯のカレンダー形式で表示するよう変更。
- 「編集する」からセルの可否（○/×）を直接編集し、「更新する」で一括保存できる導線を追加。
- 手動テンプレと学習テンプレを同じカレンダー上に統合表示し、一覧ベースUIを廃止。
- `user_schedule_blocks` をもとにした「日付ごとの予定ブロック」カレンダー表示を追加。
- 週次カレンダーと日付ごとの予定ブロックをタブ切り替えUIに変更し、表示中タブを編集できるよう改善。
- 週次カレンダーは自動学習更新を停止し、手動登録のみで更新する仕様に変更。
- 日付ごとの予定ブロック保存を最大1時間粒度へ正規化。
- 回答画面の曜日一括入力で、すでに個別編集済みのマスを上書きしないように改善。
- 日付ごとの予定ブロック表示は「現在表示中の週」単位で判定し、2時間区切りのみで構成される週は2時間単位で表示するよう改善。
- マイ予定テンプレのカレンダー表示をイベント回答UIに寄せ、表示期間バー・週送りボタン・境界時刻ラベル・2段ヘッダー（日付/曜日）へ統一。
- 週移動UIを共通コンポーネント化し、アイコン中心の操作から「前の週 / 次の週」ラベル付き操作へ統一して視認性と操作性を改善。
- アカウントページにパンくずとページタイトル（metadata）を追加し、`/account` でページ名が常に認識できるよう改善。
- 表示名称を見直し、「マイ予定テンプレ」→「マイ予定設定」、「週次カレンダー」→「週ごとの用事」、「日付ごとの予定ブロック」→「日付ごと一括管理」へ変更。
- 「日付ごと一括管理」の名称を「予定一括管理」に変更。
- 予定一括管理から回答済みイベントへの反映前に、イベントカードごとの差分カレンダープレビューを確認できるフローを追加。
- 反映フローでイベントごとに「更新 / 維持」を選択可能にし、保護された変更はデフォルト維持・任意で上書きできる設定を追加。
- 確定済みイベントはデフォルトで更新対象外とし、明示許可時のみ反映できる安全導線を追加。
- 「過去の予定から反映」は、枠ごとに参照元を切り替える仕様に修正（該当枠に日付ごとの予定があれば予定一括管理を優先し、ない枠のみ週ごとの用事を参照）。
- 回答イベントへの反映UIを再設計し、予定一括管理の更新後に変更対象があれば自動で反映確認セクションへ誘導するフローに改善。
- 反映プレビューをイベントごとの週次カレンダー表示に変更し、変更マスのみ強調しつつマス単位で「更新/維持（○/×）」を直接調整できるよう改善。
- 反映実行ボタンを「この変更を適用」に変更し、イベント詳細へ新規タブで遷移するボタンを追加。
- ログイン中の新規回答画面に、未ログイン時の既存回答を名前一致で検索して `user_event_links` へ紐づける導線を追加。
- アカウント画面に「未ログイン回答の紐づけ」セクションを追加し、履歴ベースの候補イベントごとに回答者を選択してアカウントへ紐づけられるよう改善。

## 2026-02-05

- ログイン時の予定情報を用いた自動反映・同期機能を追加。
- 回答画面の初回表示で「過去の予定から反映」の確認モーダルを追加。
- 確定イベントと重複する枠の上書き確認とバッジ表示を追加。
- 保存時に同期範囲（このイベントのみ / 全イベント）を選択する導線を追加。
- 同期範囲モーダルは、他イベントへ反映可能な回答リンクが存在する場合のみ表示するように改善。
- 週次テンプレ管理UIをアカウントページに追加。
- アカウント予定連携の設計ドキュメントを追加。
- ローカル限定の開発用ログインを追加（環境変数で有効化）。
- 自動反映の重なり判定でタイムゾーン差を吸収する処理を追加。

## 2026-02-03

- イベント作成ページを3ステップのウィザードに変更。
- ステップ2を「入力方式選択 → 設定/候補枠」に分割し、理解しやすい導線に改善。
- 手動選択は「設定 → カレンダー選択」の2段階に分離し、確認画面から戻っても選択内容を保持。
- 日付・時間帯・時間枠の入力UIを横並びで簡潔化し、モバイルでの視認性を改善。
- 方式選択カードに「おすすめ」表示を追加し、選択の迷いを軽減。
- 初回表示時は自動スクロールせず、ステップ遷移時のみスクロールする挙動に調整。
- 最終確認ステップに利用規約同意と要約表示を集約。
- イベント作成UIの設計意図をアーキテクチャドキュメントに追加。
- サイトURLを `daysynth.k-tkms.com` に統一し、OG生成時の参照URLとサイトマップを正しいドメインに修正。
- CIのNode.jsを20系に更新し、`npm ci` のロック不整合を解消。

## 2026-02-02

- PWA関連の導線と資産を撤去し、Web導線（履歴ページ）へ機能を統合。
- /home を /history へ恒久リダイレクトし、ヘッダーナビゲーションを整理。
- PWA依存（next-pwa、manifest、offlineページ）と関連テストを削除。
- ヘッダーの認証導線をサークルユーザーアイコンに統一し、ログイン時はアカウントページへ遷移、アカウントページ内でログアウトできるように変更。
- 未ログイン時はヘッダーにログイン表記を表示するように調整。
- ヘッダーナビゲーションから履歴リンクを削除。
- パンくずで「ホーム」が重複表示される問題を修正。
- ヘッダーのログイン確認中表示をスケルトンへ変更。
- 認証エラー時の導線を改善し、カスタムのログイン/エラーページで戻る/ホーム導線を追加。
- 認証エラー画面の「元のページに戻る」を callbackUrl への遷移に固定。
- 認証ページの callbackUrl を相対パスに正規化し、リダイレクト時の安全性を強化。
- ヘッダーのホームリンクを削除し、未ログイン時はゲスト表示のアイコン導線へ変更。
- ゲストアイコンのサイズを調整し、ヘッダーの高さが変わらないように修正。
- ヘッダーの導線順序を元に戻し、読み込みスケルトンの幅を調整。
- アカウントページに閲覧履歴とお気に入りイベントのセクションを追加。
- アカウントページの表示順をお気に入り→閲覧履歴に変更。
- 履歴クリア時に確認ダイアログを追加。
- イベント閲覧履歴RPCを競合に強いupsertへ更新し、実行権限を制限して安全性を強化。
- アカウントページにGoogle連携を削除する確認付きUIとサーバー削除処理を追加。
- アカウント削除をログアウト近くに移動し、ポップアップで削除フォームを表示するように変更。
- Auth.jsのAdapterが参照するスキーマをDBロールの`search_path`で`authjs`優先に設定するマイグレーションを追加。

## 2026-01-29

- Google ログインとイベント履歴同期の設計ドキュメントを追加。
- Supabase 適合性とセキュリティ観点の検討を設計ドキュメントに追記。
- Auth.js とイベント履歴同期の実装に向けた認証・履歴同期機能を追加。
- Auth.js 用のDBスキーマとイベント閲覧履歴テーブルを追加。

## 2026-01-25

- 参加者一覧・回答を公開リンク閲覧者に開放し、権限差を設けない方針を文書化。
- admin_token を将来拡張用として保持しつつ、現時点では権限判定に使わない旨を仕様書へ反映。
- アクセス権限に関するアーキテクチャメモを追加。

## 2026-01-18

- プライバシーポリシーページを追加し、外部送信や本人請求対応の内容を整理。
- プライバシーポリシー検討メモをドキュメントに追加。

## 2026-01-19

- フッターと利用規約にお問い合わせ用メールアドレスを掲示。
- 利用規約の問い合わせ文言を安全性重視の表現へ更新。
- 利用規約の最終更新日を2026年1月19日に更新し、改定履歴セクションを新規追加。
- プライバシーポリシーから参照元情報の送信に関する記載を削除し、ヘッダ設定を撤去。
- プライバシーポリシーから重要変更時の告知に関する記載を削除。

## 2025-10-19

- 選択セル以外でポインタを押下した状態でもカレンダーセルに移動したタイミングでドラッグが開始されるよう `useSelectionDragController` のポインタイベント処理を更新。
- 回答フォームのドラッグ挙動に合わせた回帰テストを追加し、セル外からのドラッグ開始や通過セルのみが反転する仕様をドキュメント化。
- 候補日程追加モーダルの詳細設定および手動選択モードで既存イベントの開始・終了時刻とインターバルを初期値に反映し、時間枠の再設定を防止。

## 2025-10-17

- 候補日程追加セクションに手動選択モードを導入し、既存日程と重複しない枠をカレンダー選択で追加できるよう改善。
- 候補日程追加時の時間枠間隔をイベント作成時の設定に固定し、異なる粒度のスロット追加を防止。
- 既存日程のパターンに応じて自動延長 / 手動選択モードを自動判定し、適切なUIを初期表示するよう調整。

## 2025-06-10

- 公開イベントURLのトークン形式をUUIDから12文字の英数字トークンへ変更し、共有性を向上。
