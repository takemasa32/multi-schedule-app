# CHANGELOG

## 2026-02-06

- アカウントページの「マイ予定テンプレ」を曜日×時間帯のカレンダー形式で表示するよう変更。
- 「編集する」からセルの可否（○/×）を直接編集し、「更新する」で一括保存できる導線を追加。
- 手動テンプレと学習テンプレを同じカレンダー上に統合表示し、一覧ベースUIを廃止。
- `user_schedule_blocks` をもとにした「日付ごとの予定ブロック」カレンダー表示を追加。
- 週次カレンダーと日付ごとの予定ブロックをタブ切り替えUIに変更し、表示中タブを編集できるよう改善。
- 週次カレンダーは自動学習更新を停止し、手動登録のみで更新する仕様に変更。
- 日付ごとの予定ブロック保存を最大1時間粒度へ正規化。
- 回答画面の曜日一括入力で、すでに個別編集済みのマスを上書きしないように改善。
- 日付ごとの予定ブロック表示は「現在表示中の週」単位で判定し、2時間区切りのみで構成される週は2時間単位で表示するよう改善。
- マイ予定テンプレのカレンダー表示をイベント回答UIに寄せ、表示期間バー・週送りボタン・境界時刻ラベル・2段ヘッダー（日付/曜日）へ統一。
- 週移動UIを共通コンポーネント化し、アイコン中心の操作から「前の週 / 次の週」ラベル付き操作へ統一して視認性と操作性を改善。
- アカウントページにパンくずとページタイトル（metadata）を追加し、`/account` でページ名が常に認識できるよう改善。
- 表示名称を見直し、「マイ予定テンプレ」→「マイ予定設定」、「週次カレンダー」→「週ごとの用事」、「日付ごとの予定ブロック」→「日付ごと一括管理」へ変更。
- 「日付ごと一括管理」の名称を「予定一括管理」に変更。
- 予定一括管理から回答済みイベントへの反映前に、イベントカードごとの差分カレンダープレビューを確認できるフローを追加。
- 反映フローでイベントごとに「更新 / 維持」を選択可能にし、保護された変更はデフォルト維持・任意で上書きできる設定を追加。
- 確定済みイベントはデフォルトで更新対象外とし、明示許可時のみ反映できる安全導線を追加。
- 「過去の予定から反映」は、枠ごとに参照元を切り替える仕様に修正（該当枠に日付ごとの予定があれば予定一括管理を優先し、ない枠のみ週ごとの用事を参照）。
- 回答イベントへの反映UIを再設計し、予定一括管理の更新後に変更対象があれば自動で反映確認セクションへ誘導するフローに改善。
- 反映プレビューをイベントごとの週次カレンダー表示に変更し、変更マスのみ強調しつつマス単位で「更新/維持（○/×）」を直接調整できるよう改善。
- 反映実行ボタンを「この変更を適用」に変更し、イベント詳細へ新規タブで遷移するボタンを追加。
- ログイン中の新規回答画面に、未ログイン時の既存回答を名前一致で検索して `user_event_links` へ紐づける導線を追加。
- アカウント画面に「未ログイン回答の紐づけ」セクションを追加し、履歴ベースの候補イベントごとに回答者を選択してアカウントへ紐づけられるよう改善。

## 2026-02-05

- ログイン時の予定情報を用いた自動反映・同期機能を追加。
- 回答画面の初回表示で「過去の予定から反映」の確認モーダルを追加。
- 確定イベントと重複する枠の上書き確認とバッジ表示を追加。
- 保存時に同期範囲（このイベントのみ / 全イベント）を選択する導線を追加。
- 同期範囲モーダルは、他イベントへ反映可能な回答リンクが存在する場合のみ表示するように改善。
- 週次テンプレ管理UIをアカウントページに追加。
- アカウント予定連携の設計ドキュメントを追加。
- ローカル限定の開発用ログインを追加（環境変数で有効化）。
- 自動反映の重なり判定でタイムゾーン差を吸収する処理を追加。

## 2026-02-03

- イベント作成ページを3ステップのウィザードに変更。
- ステップ2を「入力方式選択 → 設定/候補枠」に分割し、理解しやすい導線に改善。
- 手動選択は「設定 → カレンダー選択」の2段階に分離し、確認画面から戻っても選択内容を保持。
- 日付・時間帯・時間枠の入力UIを横並びで簡潔化し、モバイルでの視認性を改善。
- 方式選択カードに「おすすめ」表示を追加し、選択の迷いを軽減。
- 初回表示時は自動スクロールせず、ステップ遷移時のみスクロールする挙動に調整。
- 最終確認ステップに利用規約同意と要約表示を集約。
- イベント作成UIの設計意図をアーキテクチャドキュメントに追加。
- サイトURLを `daysynth.k-tkms.com` に統一し、OG生成時の参照URLとサイトマップを正しいドメインに修正。
- CIのNode.jsを20系に更新し、`npm ci` のロック不整合を解消。

## 2026-02-02

- PWA関連の導線と資産を撤去し、Web導線（履歴ページ）へ機能を統合。
- /home を /history へ恒久リダイレクトし、ヘッダーナビゲーションを整理。
- PWA依存（next-pwa、manifest、offlineページ）と関連テストを削除。
- ヘッダーの認証導線をサークルユーザーアイコンに統一し、ログイン時はアカウントページへ遷移、アカウントページ内でログアウトできるように変更。
- 未ログイン時はヘッダーにログイン表記を表示するように調整。
- ヘッダーナビゲーションから履歴リンクを削除。
- パンくずで「ホーム」が重複表示される問題を修正。
- ヘッダーのログイン確認中表示をスケルトンへ変更。
- 認証エラー時の導線を改善し、カスタムのログイン/エラーページで戻る/ホーム導線を追加。
- 認証エラー画面の「元のページに戻る」を callbackUrl への遷移に固定。
- 認証ページの callbackUrl を相対パスに正規化し、リダイレクト時の安全性を強化。
- ヘッダーのホームリンクを削除し、未ログイン時はゲスト表示のアイコン導線へ変更。
- ゲストアイコンのサイズを調整し、ヘッダーの高さが変わらないように修正。
- ヘッダーの導線順序を元に戻し、読み込みスケルトンの幅を調整。
- アカウントページに閲覧履歴とお気に入りイベントのセクションを追加。
- アカウントページの表示順をお気に入り→閲覧履歴に変更。
- 履歴クリア時に確認ダイアログを追加。
- イベント閲覧履歴RPCを競合に強いupsertへ更新し、実行権限を制限して安全性を強化。
- アカウントページにGoogle連携を削除する確認付きUIとサーバー削除処理を追加。
- アカウント削除をログアウト近くに移動し、ポップアップで削除フォームを表示するように変更。
- Auth.jsのAdapterが参照するスキーマをDBロールの`search_path`で`authjs`優先に設定するマイグレーションを追加。

## 2026-01-29

- Google ログインとイベント履歴同期の設計ドキュメントを追加。
- Supabase 適合性とセキュリティ観点の検討を設計ドキュメントに追記。
- Auth.js とイベント履歴同期の実装に向けた認証・履歴同期機能を追加。
- Auth.js 用のDBスキーマとイベント閲覧履歴テーブルを追加。

## 2026-01-25

- 参加者一覧・回答を公開リンク閲覧者に開放し、権限差を設けない方針を文書化。
- admin_token を将来拡張用として保持しつつ、現時点では権限判定に使わない旨を仕様書へ反映。
- アクセス権限に関するアーキテクチャメモを追加。

## 2026-01-18

- プライバシーポリシーページを追加し、外部送信や本人請求対応の内容を整理。
- プライバシーポリシー検討メモをドキュメントに追加。

## 2026-01-19

- フッターと利用規約にお問い合わせ用メールアドレスを掲示。
- 利用規約の問い合わせ文言を安全性重視の表現へ更新。
- 利用規約の最終更新日を2026年1月19日に更新し、改定履歴セクションを新規追加。
- プライバシーポリシーから参照元情報の送信に関する記載を削除し、ヘッダ設定を撤去。
- プライバシーポリシーから重要変更時の告知に関する記載を削除。

## 2025-10-19

- 選択セル以外でポインタを押下した状態でもカレンダーセルに移動したタイミングでドラッグが開始されるよう `useSelectionDragController` のポインタイベント処理を更新。
- 回答フォームのドラッグ挙動に合わせた回帰テストを追加し、セル外からのドラッグ開始や通過セルのみが反転する仕様をドキュメント化。
- 候補日程追加モーダルの詳細設定および手動選択モードで既存イベントの開始・終了時刻とインターバルを初期値に反映し、時間枠の再設定を防止。

## 2025-10-17

- 候補日程追加セクションに手動選択モードを導入し、既存日程と重複しない枠をカレンダー選択で追加できるよう改善。
- 候補日程追加時の時間枠間隔をイベント作成時の設定に固定し、異なる粒度のスロット追加を防止。
- 既存日程のパターンに応じて自動延長 / 手動選択モードを自動判定し、適切なUIを初期表示するよう調整。

## 2025-06-10

- 公開イベントURLのトークン形式をUUIDから12文字の英数字トークンへ変更し、共有性を向上。
