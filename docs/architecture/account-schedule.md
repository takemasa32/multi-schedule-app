# アカウント予定連携の設計

作成日: 2026-02-05
作成者: Codex（GPT-5）

## 背景

- ログインユーザーの予定情報を活用し、回答入力の負担を減らす。
- 確定イベントと重複する枠を基本的にブロックし、安全な運用にする。
- 手動上書きはイベント単位で保持し、他イベントへ波及させない。

## 方針

- 初回回答時に「過去の予定から反映しますか？」を確認し、同意した場合のみ自動反映する。
- 確定イベントと重複する枠は選択不可だが、個別の確認で上書き可能。
- 自動反映ロジックは **可は内包、不可は重なり** を採用する。
- 同期範囲の選択は、同期対象になり得る他イベントがある場合のみ表示する（このイベントのみ / 全イベント）。
- 手動上書きは「そのイベントのその枠だけ」に限定し、他イベントへは波及させない。

## データモデル

- `user_event_links`: ユーザーとイベントの紐付け。
- `user_schedule_blocks`: 実日時の予定ブロック（可/不可）。
- `user_schedule_templates`: 週次テンプレ（手動登録のみ）。
- `user_event_availability_overrides`: 重複枠の手動上書き。

## 自動反映ルール

- **可（○）**: 予定ブロックが候補枠を完全に内包する場合のみ反映。
- **不可（×）**: 予定ブロックが1分でも重なる場合に反映。
- 判定不可は自動反映せず、既存回答を維持。

## 手動上書き

- 重複枠は確認ダイアログで上書き可能。
- 上書き後も「重複しています」バッジを維持。
- 上書きは `user_event_availability_overrides` に保存し、同期時に常に尊重する。

## 画面仕様

- 回答画面の初回表示で自動反映の確認モーダルを表示。
- 曜日ごとの時間帯設定で `設定を適用する` を押した際は、`今回のみ適用 / ユーザ設定への反映 / キャンセル` の確認ダイアログを表示する。
- ユーザ設定への反映を選んだ場合は、曜日×時間帯の設定を `user_schedule_templates(source=manual)` に保存・更新してから、そのイベントの入力マスへ適用する。
- ユーザ設定への反映ボタン文言は、差分判定に応じて `保存して適用 / 更新して適用 / 保存・更新して適用 / 維持して適用` を切り替える。
- 保存時に同期対象がある場合のみ同期範囲の選択ダイアログを表示。
- アカウントページで予定テンプレを管理できる。
- マイ予定テンプレは曜日×時間帯のカレンダー形式のみで表示・編集する。
- 週次カレンダーは手動登録または週単位一括入力で更新し、自動学習では更新しない。
- `編集する` からセル編集（○/×/-）して `更新する` で保存する。`-` は手動テンプレ削除として扱う。
- 日付ごとの予定データ（`user_schedule_blocks`）は別カレンダーで表示し、実日時ベースの反映状況を確認できるようにする。
- 週次カレンダー / 日付ごとの予定ブロックはタブで切り替える。表示中タブのみ編集モードへ入り、更新操作を行う。
- 日付ごとの予定ブロックはデータ保存時に最大1時間粒度へ正規化する。
- 未ログイン時に作成した回答をログイン後に回収できるよう、アカウント画面に「未ログイン回答の紐づけ」導線を設ける。
- 紐づけは閲覧履歴と未紐づけイベントをもとに候補を表示し、イベントごとに回答者（participant）を選択して `user_event_links` へ保存する。
