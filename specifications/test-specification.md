# 複数日程調整アプリ テスト仕様書

## 1. テスト全体方針

- **目的**: 主要機能の品質保証・リグレッション防止・将来の拡張性担保
- **対象**: サーバーアクション/API、UI コンポーネント、PWA・お気に入り・履歴、カレンダー連携、E2E（統合・ユーザー操作）
- **ツール**: Jest（ユニット/結合/統合）、Playwright（E2E）、Supabase ローカル DB
- **運用**: 型・Lint エラーゼロ、CI 自動実行、テストデータ分離・自動クリーンアップ

---

## 2. テスト分類・粒度

### 2.1 ユニットテスト（Jest）

- **サーバーアクション**:
  - 正常系・異常系（バリデーション、DB エラー、権限エラー）
  - CRUD（イベント作成・回答送信・日程確定・カレンダー生成）
- **UI コンポーネント**:
  - 入力フォーム（バリデーション、エラー表示、送信動作）
  - 回答集計表示（リスト/ヒートマップ/個別切替、人数集計）
  - お気に入り・履歴 UI（追加・削除・一覧・即時反映）

### 2.2 統合テスト（Jest ＋ Supabase ローカル）

- **DB マイグレーション・シード**:
  - テスト前に`supabase db reset --force --seed`で初期化
- **API/DB 一貫性**:
  - 実 DB を使い、API 経由での CRUD・集計・RLS 制約の検証
  - テスト後にテーブル truncate でクリーンアップ

### 2.3 E2E テスト（Playwright）

- **ユーザーフロー**:
  - イベント作成 → リンク共有 → 参加者回答 → 主催者確定 → カレンダー連携
  - PWA インストール・オフライン・お気に入り・履歴・URL 直遷移
- **認証/セッション**:
  - （将来）ログイン/ログアウト、トークン管理
- **CI/CD 連携**:
  - サーバー・Supabase 同時起動、ヘッドレス実行、HTML レポート出力

---

## 3. テスト運用ルール

- **ディレクトリ構成**
  - `src/lib/__tests__/` ... サーバーアクション・ユーティリティ
  - `src/components/__tests__/` ... UI コンポーネント
  - `e2e/` ... Playwright E2E
- **命名規則**
  - `*.test.ts(x)`、E2E は`*.spec.ts`
- **データ管理**
  - テスト用 DB・ユーザー・イベントを本番と完全分離
  - シード・クリーンアップ自動化
- **CI/CD**
  - GitHub Actions 等で自動実行、失敗時はレポート保存
- **追加・修正時の注意**
  - 仕様書に沿ったケース網羅、グローバルモック/ポリフィル明示
  - `@ts-expect-error`には理由コメント必須
  - 実装・修正内容はコミット/PR 本文に明記

---

## 4. テストケース例（抜粋）

### サーバーアクション

- [x] イベント作成（正常/タイトル未入力/日程未入力/DB エラー）
- [x] 回答送信（正常/必須項目未入力/既存参加者上書き/DB エラー）
- [x] 日程確定（正常/権限不正/日程不正/DB エラー）

### UI

- [x] イベント作成フォーム（バリデーション/送信/エラー表示）
- [x] 回答フォーム（入力/送信/エラー/利用規約同意）
- [x] 回答集計（リスト/ヒートマップ/個別/参加者 0 件）
- [x] お気に入り・履歴（追加/削除/一覧/即時反映）

### 統合/E2E

- [ ] イベント作成 → 参加者回答 → 主催者確定 → カレンダー連携
  - トップページから新規イベントを作成し、公開 URL/管理 URL が発行されること
  - 参加者用 URL にアクセスし、名前と可否を入力して送信できること
  - 回答後、集計が正しく反映されること
  - 管理 URL で確定操作ができ、確定日程が全員に表示されること
  - 確定後、.ics ダウンロード・Google カレンダーリンクが正しく動作すること
- [ ] PWA インストール・オフライン・履歴・お気に入り
  - PWA としてインストールできること
  - オフライン時に offline.html が表示されること
  - イベント詳細でお気に入り登録/解除ができ、/home で一覧表示されること
  - 履歴が自動で記録・表示されること
- [ ] イベント URL/ID から開く
  - /home でイベント URL/ID 入力 → 該当イベントに遷移できること
- [ ] エラー時の UI・リカバリ
  - 存在しないイベント ID や不正な操作時にエラーメッセージが表示されること
- [ ] DB リセット・シード・クリーンアップ自動化
  - テスト前後で DB 初期化・クリーンアップが自動で行われること

---

## 5. ベストプラクティス

- テスト用 DB は`supabase db reset --force --seed`で毎回初期化
- Playwright は`concurrently`/`wait-on`でサーバー・DB 起動を同期
- テストデータは最小限・明示的に投入、テスト後は必ず削除
- E2E はトレース・ビデオ記録を有効化し、失敗時のデバッグ容易化
- すべてのテストは型・Lint エラーゼロでコミット

---

## 6. データベース（RLS/SQL）テスト戦略・CI 自動化

### 6.1 DB レイヤーの RLS/SQL テスト

- Supabase CLI ＋ pgTAP で DB レイヤーの RLS・制約を自動テスト
- テストは`supabase/tests/`配下に SQL ファイルで管理し、`supabase test db`で一括実行
- 各テストはトランザクションで囲み、ロールバックでアイソレーション
- シードデータ（`supabase/seed.sql`）で初期状態を保証
- RLS（認証/匿名ユーザー）の CRUD 成功・失敗ケースを網羅
- 例：events/participants/availabilities テーブルの RLS 成功・失敗、他イベントのトークンでのアクセス不可など

### 6.2 CI/CD 自動化

- GitHub Actions 等で以下を自動化
  1. Supabase CLI セットアップ
  2. ローカルスタック起動
  3. マイグレーション・シード適用
  4. DB テスト（`supabase test db`）
  5. ユニット・E2E テスト
  6. レポート集約
- PR ごとに自動テストを回し、マージ前に品質担保

### 6.3 E2E テストの DB 初期化

- Playwright ＋ Supawright 等で E2E 前後に DB 初期化・クリーンアップを自動化
- テスト用 DB は`supabase db reset --force --seed`で毎回初期化
- 主要なユーザーフロー（イベント作成 → 回答 → 確定 → カレンダー連携等）を網羅

---

## 7. 参考・補足

- Supabase 公式: https://supabase.com/docs/guides/database/testing
- pgTAP: https://pgtap.org/
- Supawright: https://github.com/isaacharrisholt/supawright
- Basejump: https://usebasejump.com/blog/testing-on-supabase-with-pgtap

---

この仕様書は今後のテスト実装・運用の指針とします。
